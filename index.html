<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <head>
        <script src="https://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="d3-grid.js"></script>
        <script type="text/javascript" src="util.js"></script>
        <script type="text/javascript" src="constants.js"></script>
        <link rel="stylesheet" href="index.css">
    </head>
    <title>Covid19 Visualization</title>
    <body>
        <div class="container">
            <div class="controls">
                <button id="startButton" class="myButton" onclick="runSimulation()">Start Simulation</button>
                <br/>
                <button id="nextDay" class="myButton" onclick="nextDay()">Next Day </button>
            </div>
            <div class="vis"></div>
            <div class="display_variables">
                <div>Total population:
                    <span id="population"> 100000 </span>
                </div>
                <div>
                    Day Number: <span id="curDay">0</span>
                </div>
                <div>
                    Number Infected: <span id="numInfected">0</span>
                </div>
            </div>
        </div>

        <div class="parameters">
            Initial infection rate <b>(<span id="initialInfectionRateValue">5%</span>)</b>:
            0% <input id="initialInfectionRate" class="slider" type="range" min="0" max="10" step="0.1" value="5"> 10%
            &emsp;
            Simulation Infection Rate <b>(<span id="infectionRateValue">10%</span>)</b>:
            0% <input id="rate" class="slider" type="range"  min="0" max="25" value = 10> 25%
            <br/>
            Minimum Neighborhood Population <b>(<span id="minValue">55 people</span>)</b>:
            10 <input id="min" class="slider" type="range" min="10" max="100" value=55> 100
            &emsp;
            Maximum Neighborhood Population <b>(<span id="maxValue">2750 people</span>)</b>:
            500 <input id="max" type="range" min="500" max="5000" value="2750" class="slider"> 5000
            <br/>
            Number of Days <b>(<span id="numDaysValue"></span>)</b>:
            1 <input id="numDays" class="slider" type="range" > <span id="maxDays"></span>
            &emsp;
            Simulation Speed <b>(<span id="speedValue">10 </span> days per second)</b> :
            1 <input id="speed" class="slider" type="range" min="1" max="10" value="10"> 10
        </div>



    </body>
</head>
<body>

<script>

let rows_cols = Math.sqrt(num_neighborhoods);
document.getElementById("minValue").innerHTML = document.getElementById("min").value + " people";
document.getElementById("maxValue").innerHTML = document.getElementById("max").value + " people";

//assuming num_neighborhoods is a perfect square
let neighborhood_min = parseInt(document.getElementById("min").value);
let neighborhood_max = parseInt(document.getElementById("max").value);
let neighborhood_populations = distribute_population(neighborhood_min, neighborhood_max);
document.getElementById("min").oninput = function() {
    document.getElementById("minValue").innerHTML = this.value + " people";
}

document.getElementById("min").onmouseup = function() {
    document.getElementById("minValue").innerHTML = this.value + " people";
    neighborhood_min = parseInt(this.value);
    neighborhood_populations = distribute_population(neighborhood_min, neighborhood_max);
    updateRects();
    distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
    updatePoints();
}
document.getElementById("min").ontouchend = function() {
    document.getElementById("minValue").innerHTML = this.value + " people";
    neighborhood_min = parseInt(this.value);
    neighborhood_populations = distribute_population(neighborhood_min, neighborhood_max);
    updateRects();
    distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
    updatePoints();
}

document.getElementById("max").oninput = function() {
    document.getElementById("maxValue").innerHTML = this.value + " people";
}

document.getElementById("max").onmouseup = function() {
    document.getElementById("maxValue").innerHTML = this.value + " people";
    neighborhood_max = parseInt(this.value);
    neighborhood_populations = distribute_population(neighborhood_min, neighborhood_max);
    updateRects();
    distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
    updatePoints();
}

document.getElementById("max").ontouchend = function() {
    document.getElementById("maxValue").innerHTML = this.value + " people";
    neighborhood_max = parseInt(this.value);
    neighborhood_populations = distribute_population(neighborhood_min, neighborhood_max);
    updateRects();
    distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
    updatePoints();
}

let infection_rate = 1 + (document.getElementById("rate").value / 100);

var cur_infections = 0;
//represents the number of infections in each neighborhood
let neighborhood_infections = Array(num_neighborhoods).fill(0);
let cur_infectionable = Object.assign({},neighborhood_infections);
distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
document.getElementById("numInfected").innerHTML = cur_infections;

var cur_days = 0;
let num_days = 0;
updateNumDaysUI();


document.getElementById("numDays").oninput = function () {
    document.getElementById("numDaysValue").innerHTML = this.value  + " days";
    num_days = parseInt(this.value);
}

let max_radius = 25;
//dimensions of the grid, assumed to be a square.
let gridSize = max_radius * rows_cols * 2;
//svg dimensions
 let width = gridSize * 1.15,
     height = gridSize * 1.15;

// var points = [];
var rects = [];
//grid dimensions
// let pointGrid = d3.layout.grid()
//     .points()
//     .size([gridSize, gridSize])
//     .rows([rows_cols])
//     .cols([rows_cols])

var rectGrid = d3.layout.grid()
    .bands()
    .size([gridSize, gridSize])
    .rows([rows_cols])
    .cols([rows_cols]);

var svg = d3.select(".vis").append("svg")
    .attr({
        width: width,
        height: height
    })
    .attr("class", "visualization")
    .attr("transform", "translate(70,70)");


for (var i = 0; i < neighborhood_infections.length; i++) {
    let radius = neighborhood_infections[i] / neighborhood_populations[i] * max_radius;
    addNeighborhood(neighborhood_populations[i],radius);
}

document.getElementById("rate").oninput = function() {
    document.getElementById("infectionRateValue").innerHTML = this.value + "%";
    infection_rate =  1 + (document.getElementById("rate").value / 100);
}

document.getElementById("rate").onmouseup = function() {
    infection_rate =  1 + (document.getElementById("rate").value / 100);
    if (document.getElementById("numDays").disabled === false) {
        updateNumDaysUI();
    }
}

document.getElementById("initialInfectionRate").oninput = function() {
    document.getElementById("initialInfectionRateValue").innerHTML = this.value + "%";
    document.getElementById("numInfected").innerHTML = Math.floor(this.value / 100 * parseInt(document.getElementById("population").innerHTML));
}

document.getElementById("initialInfectionRate").onmouseup = function() {
    distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
    updateNumDaysUI();
    updatePoints();
}
document.getElementById("initialInfectionRate").ontouchend = function() {
    distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
    updateNumDaysUI();
    updatePoints();
}

function updateNumDaysUI() {
    document.getElementById("numDays").max = Math.ceil(getBaseLog(infection_rate, population / cur_infections));
    document.getElementById("maxDays").innerHTML = document.getElementById("numDays").max;
    document.getElementById("numDays").value = document.getElementById("numDays").max;
    num_days = document.getElementById("numDays").value;
    document.getElementById("numDaysValue").innerHTML = num_days + " days";
}
/**
 * calculates and distributes infections to clean neighborhoods
 **/
function distributeInitialInfections(infection_rate) {
    neighborhood_infections = Array(num_neighborhoods).fill(0);
    cur_infectionable = Object.assign({},neighborhood_infections);
    cur_infections = Math.floor(infection_rate * population);
    distribute_infections(cur_infections);
}
/**
 * Gets the corresponding grayscale color for a neighborhood population
 **/
function get_color_for_population(population) {
    for (const scale of population_to_grayscale_color) {
        if (population >= scale["min"] && population <= scale["max"]) {
            return scale["color"];
        }
    }
}
function addNeighborhood(population, radius) {
    rects.push({});
    var rectangles = svg.selectAll("g")
        .data(rectGrid(rects))
        .enter()
        .append("g");

    rectangles.append("rect")
        .attr("width", max_radius * 2)
        .attr("height", max_radius * 2)
        .attr("class", "rect")
        .attr("fill", get_color_for_population(population))
        .attr("stroke", "black")
        .attr("stroke-opacity","0.1")
        .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

    rectangles.append("circle")
        .attr("class", "point")
        .attr("cx", function (d) { return d.x+(max_radius) ; })
        .attr("cy", function (d) { return d.y+(max_radius); })
        .attr("r", radius)
        .attr("fill", "red");
}

function updateRects() {
    var rect = svg.selectAll(".rect")
        .data(rectGrid(rects));
    rect.each(function (d, i) {
        var new_color = get_color_for_population(neighborhood_populations[i])
        d3.select(this).transition().attr("fill", new_color);
    })
}
/**
 * updates points according to infection densities
 **/
function updatePoints() {
    var point = svg.selectAll(".point")
        .data(rectGrid(rects));
    point.each(function (d, i) {
        var new_radius = Math.min(max_radius, (neighborhood_infections[i] / neighborhood_populations[i]) * max_radius);
        d3.select(this).transition().attr("r", new_radius);
    })
}

/**
 * Distributes population to neighborhoods
 */
function distribute_population(min, max) {
    if (min * num_neighborhoods > population) {
        throw new Error("minimum neighborhood population too high");
    } else if (max * num_neighborhoods < population) {
        throw new Error("maximum neighborhood population too low");
    } else if (min > max) {
        throw new Error("min neighborhood population can't be greater than max");
    }
    var neighborhoods = Array(num_neighborhoods).fill(min);
    var pop_to_be_filled = population - num_neighborhoods * min;
    //represents non-full neighborhoods
    neighborhoods = distribute_add(neighborhoods, pop_to_be_filled);
    var cur_populable = Object.assign({}, neighborhoods);
    // enforce max, check for leftovers.
    var leftover = 0;
    for (var i in cur_populable) {
        if (cur_populable[i] >= max) {
            leftover += (cur_populable[i] - max);
            neighborhoods[i] = max;
            delete cur_populable[i];
        }
    }
    //keep distributing leftover until it's 0 and everything is below max
    while (leftover > 0) {
        cur_populable = distribute_add_dict(cur_populable, leftover);
        leftover = 0;
        for (var i in cur_populable) {
            neighborhoods[i] = cur_populable[i];
            if (cur_populable[i] >= max) {
                leftover += (cur_populable[i] - max);
                neighborhoods[i] = max;
                delete cur_populable[i];
            }
        }
        console.log("leftover is " + leftover);
    }

    console.log("total population check:" +
        neighborhoods.reduce((a, b) => a + b, 0)
    );
    return neighborhoods;
}

/**
 * distributes num_infections into neighborhood_infections array
 * updates cur_infectionable to have only non-fully infected neighborhoods
 * @param num_infections
 */
function distribute_infections(num_infections){
    cur_infectionable = distribute_add_dict(cur_infectionable, num_infections);
    console.log("cur_infectionable at beginning is ");
    console.log(cur_infectionable);
    var leftover = 0;
    for (var i in cur_infectionable) {
        neighborhood_infections[i] = cur_infectionable[i];
        // console.log("cur_infectionable at " + i  + " is  " + cur_infectionable[i]);
        // console.log("set neighborhood " + i + " to have infections " + neighborhood_infections[i]);
        if (cur_infectionable[i] >= neighborhood_populations[i]) {
            leftover += (cur_infectionable[i] - neighborhood_populations[i]);
            neighborhood_infections[i] = neighborhood_populations[i];
            delete cur_infectionable[i];
        }
    }
    while (leftover > 0) {
        cur_infectionable = distribute_add_dict(cur_infectionable, leftover);

        leftover = 0;
        for (var i in cur_infectionable) {
            neighborhood_infections[i] = Number(cur_infectionable[i]);
            if (cur_infectionable[i] >= neighborhood_populations[i]) {
                leftover += (cur_infectionable[i] - neighborhood_populations[i]);
                neighborhood_infections[i] = neighborhood_populations[i];
                delete cur_infectionable[i];
            }
        }
    }
}

/**
 * Takes in simulation speed in days per second and converts to milliseconds per day.
 **/
function getSimulationSpeed(days_per_second) {
    return 1000 / days_per_second;
}

let simulation_speed = getSimulationSpeed(parseInt(document.getElementById("speed").value));
console.log("simulation speed is " + simulation_speed);

var tick = 0;
var running = false;

document.getElementById("speed").oninput = function() {
    document.getElementById("speedValue").innerHTML = this.value;
    simulation_speed = getSimulationSpeed(parseInt(document.getElementById("speed").value));
    if (running === true) {
        clearInterval(tick);
        tick = setInterval(update, simulation_speed);
    }
}
function nextDay() {
    if (cur_infections < population) {
        let num_new_infections = Math.min(population - cur_infections, Math.floor(infection_rate * cur_infections - cur_infections));
        cur_infections = cur_infections + num_new_infections;
        console.log("cur infections is currently " + cur_infections);
        distribute_infections(num_new_infections);
        updatePoints();
        cur_days += 1;
        document.getElementById("curDay").innerHTML = cur_days;
        document.getElementById("numInfected").innerHTML = cur_infections;
    }
    if (cur_infections >= population) {
        document.getElementById("nextDay").disabled = true;
    }
}

var reachedEnd = false;

function runSimulation() {
    if (running === false) {
        if (reachedEnd === false) {
            running = true;
            disableControls();
            tick = setInterval(update, simulation_speed);
        } else {
            //this is if user clicked the button when it said "new simulation"
            reachedEnd = false;
            cur_days = 0;
            neighborhood_infections = Array(num_neighborhoods).fill(0);
            cur_infectionable = Object.assign({},neighborhood_infections);
            distributeInitialInfections((document.getElementById("initialInfectionRate").value) / 100);
            updatePoints();
            enableControls();
            updateDisplayVariables();
            updateNumDaysUI();
            document.getElementById("startButton").innerHTML = "Start Simulation";
        }
    }
}

function update() {
    //check if everyone has been infected
    if (cur_infections >= population || cur_days >= num_days) {
        reset();
        return;
    }
    let num_new_infections = Math.min(population - cur_infections, Math.floor(infection_rate * cur_infections - cur_infections));

    cur_infections = cur_infections + num_new_infections;
    console.log("cur infections is currently " + cur_infections);
    distribute_infections(num_new_infections);
    updatePoints();
    cur_days += 1;
    updateDisplayVariables();
}
function updateDisplayVariables() {
    document.getElementById("curDay").innerHTML = cur_days;
    document.getElementById("numInfected").innerHTML = cur_infections;
}
/**
 * Happens at the end of the simulation
 */
function reset() {
    clearInterval(tick);
    reachedEnd = true;
    running = false;
    document.getElementById("startButton").innerHTML="New Simulation";
    document.getElementById("startButton").disabled = false;
    if (cur_infections < population) {
        document.getElementById("nextDay").disabled = false;
    }
}
function enableControls() {
    document.getElementById("initialInfectionRate").disabled = false;
    document.getElementById("min").disabled = false;
    document.getElementById("max").disabled = false;
    document.getElementById("numDays").disabled = false;
    document.getElementById("nextDay").disabled = false;
}

/**
 * disables controls that shouldn't be changed when simulation is running
 */
function disableControls() {
    document.getElementById("startButton").disabled = true;
    document.getElementById("initialInfectionRate").disabled = true;
    document.getElementById("min").disabled = true;
    document.getElementById("max").disabled = true;
    document.getElementById("numDays").disabled = true;
    document.getElementById("nextDay").disabled = true;
}
</script>
</body>
</html>